<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Car API Frontend</title>
  <style>
    body { font-family: sans-serif; margin: 2rem; }
    section { margin-bottom: 2rem; }
    input, textarea { display: block; margin: 0.5rem 0; width: 300px; }
    button { margin-top: 0.5rem; }
    pre { background: #f4f4f4; padding: 1rem; }
  </style>
</head>
<body>
  <h1>Car API Frontend</h1>

  <!-- <section>
    <h2>Add Car</h2>
    <input id="add-manufacturer" placeholder="manufacturer">
    <input id="add-model" placeholder="model">
    <input id="add-year" placeholder="year" type="number">
    <input id="add-country" placeholder="country_region">
    <input id="add-type" placeholder="type_">
    <button onclick="addCar()">Add Car</button>
  </section> -->

  <section>
    <h2>Get Cars</h2>
    <input id="get-manufacturer" placeholder="manufacturer">
    <input id="get-model" placeholder="model">
    <button onclick="getCars()">Fetch Cars</button>
    <pre id="cars-output"></pre>
  </section>

  <section>
    <h2>Check Existence</h2>
    <input id="check-manufacturer" placeholder="manufacturer">
    <input id="check-model" placeholder="model (optional)">
    <input id="check-field" placeholder="field (e.g. Pack_SOC)">
    <textarea id="check-json" placeholder='target_json_str (escaped JSON string)'></textarea>
    <button onclick="checkExistence()">Check</button>
    <pre id="check-output"></pre>
  </section>

  <script>
    // const API = "http://127.0.0.1:3000";
    const API = "http://127.0.0.1:8000";

    async function addCar() {
      const body = {
        manufacturer: document.getElementById("add-manufacturer").value,
        model: document.getElementById("add-model").value,
        year: parseInt(document.getElementById("add-year").value),
        country_region: document.getElementById("add-country").value,
        type_: document.getElementById("add-type").value
      };
      const res = await fetch(`${API}/cars`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      alert(await res.text());
    }

    async function getCars() {
      const manu = document.getElementById("get-manufacturer").value;
      const model = document.getElementById("get-model").value;
      const res = await fetch(`${API}/cars/${manu}/${model}`);
      document.getElementById("cars-output").textContent = await res.text();
    }

    function parseTargetJson() {
        const raw = document.getElementById("check-json").value.trim();
        try {
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed : [parsed];
        } catch {
        alert("Invalid JSONâ€”please fix the textarea input!");
        throw new Error("Invalid JSON");
        }
    }
// ... (your existing HTML and other JavaScript functions)

// ... (your existing HTML and other JavaScript functions)

async function checkExistence() {
    let targetArr;
    try {
        targetArr = parseTargetJson();
    } catch {
        return; // abort if JSON is bad
    }
    const body = {
        manufacturer: document.getElementById("check-manufacturer").value,
        model: document.getElementById("check-model").value,
        field: document.getElementById("check-field").value,
        target_json_arr: targetArr
    };

    const res = await fetch(`${API}/check_existence`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
    });
    
    // Check if the response is successful
    if (!res.ok) {
        document.getElementById("check-output").textContent = `Error: ${res.status} - ${await res.text()}`;
        return;
    }

    const data = await res.json();
    const outputDiv = document.getElementById("check-output");
    outputDiv.textContent = ""; // Clear previous output

    if (data.exists) {
        let outputText = "Matches found:\n\n";
        data.matches.forEach((match, index) => {
            // Use toFixed(2) to format the score to two decimal places
            const score = (match.similarity_score * 100).toFixed(2);
            outputText += `Match ${index + 1}:\n`;
            outputText += `  Manufacturer: ${match.manufacturer}\n`;
            outputText += `  Model: ${match.model}\n`;
            outputText += `  Field: ${match.field}\n`;
            outputText += `  Similarity Score: ${score}%\n`;
            // Add the stringified command for display
            outputText += `  Command: ${JSON.stringify(match.command, null, 2)}\n\n`;
        });
        outputDiv.textContent = outputText;
    } else {
        outputDiv.textContent = "No similar commands found.";
    }
}
    // async function checkExistence() {
    //    let targetArr;
    //     try {
    //     targetArr = parseTargetJson();
    //     } catch {
    //     return; // abort if JSON is bad
    //     }
    //   const body = {
    //     manufacturer: document.getElementById("check-manufacturer").value,
    //     model: document.getElementById("check-model").value,
    //     field: document.getElementById("check-field").value,
    //     target_json_arr: targetArr
    //   };
    //   const res = await fetch(`${API}/check_existence`, {
    //     method: "POST",
    //     headers: { "Content-Type": "application/json" },
    //     body: JSON.stringify(body)
    //   });
    //   document.getElementById("check-output").textContent = await res.text();
    // }
  </script>
</body>
</html>